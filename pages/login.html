<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../assets/css/user_form.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <title>Sign in</title>
  </head>
  <body>
    <div class="container">
      <form action="user/login" method="POST" class="form" id="login-form">
        <div class="logo-container">
          <img src="../assets/img/logo.png" alt="Kanji Logo" class="logo" />
        </div>
        <div class="spacer"></div>

        <div class="form-group">
          <label for="username" class="form-label">Tên đăng nhập</label>
          <input
            id="username"
            name="username"
            type="text"
            placeholder="Username..."
            class="form-control"
            rules="required|min:3|max:20"
          />
          <span class="form-message"></span>
        </div>

        <div class="form-group">
          <label for="password" class="form-label">Mật khẩu</label>
          <input
            id="password"
            name="password"
            type="password"
            placeholder="Mật khẩu..."
            class="form-control"
            rules="required|min:6"
          />
          <span class="form-message"></span>
        </div>

        <button type="submit" class="form-submit">Đăng nhập</button>
      </form>
    </div>

    <!-- Loader overlay -->
    <div class="modal loader-overlay">
      <div class="loader"></div>
    </div>

    <div class="modal" id="success-popup">
      <div class="popup show">
        <div class="popup-icon">
          <i class="fa-solid fa-check"></i>
        </div>
        <h2 class="popup-title">Success!</h2>
        <h3 class="popup-description">Đăng nhập thành công.</h3>
        <div class="popup-close-button">
          <button id="close-popup-btn">Đóng</button>
        </div>
      </div>
    </div>
    <div class="modal" id="failed-popup">
      <div class="popup show">
        <div class="popup-icon">
          <i class="fa-solid fa-x"></i>
        </div>
        <h2 class="popup-title">Failed!</h2>
        <h3 class="popup-description">Đăng nhập thất bại.</h3>
        <div class="popup-close-button">
          <button id="close-popup-btn">Đóng</button>
        </div>
      </div>
    </div>

    <script src="../assets/js/validator.js"></script>

    <script>
      const validator = new Validator("#login-form");

      validator.onSubmit = function (formValues) {
        showLoading();
        login(formValues);
      };

      async function login(formData) {
        try {
          const response = await fetch("http://localhost:8080/user/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const result = await response.json();
          if (response.ok) {
            showSuccessPopup(); // Show success popup on successful registration
          } else {
            showFailedPopup(result.message || "Đăng nhập thất bại!"); // Show error popup
          }
        } catch (error) {
          showFailedPopup("Có lỗi trong quá trình đăng ký: " + error.message); // Show error message
        } finally {
          hideLoading();
        }
      }

      function showSuccessPopup() {
        const popup = document.getElementById("success-popup");
        popup.classList.add("active");

        setTimeout(() => {
          window.location.href = "../index.html";
        }, 2000);
      }

      function showFailedPopup(errorMessage) {
        const popup = document.getElementById("failed-popup");
        const popupDescription = popup.querySelector(".popup-description");
        popupDescription.textContent = errorMessage; // Update error message
        popup.classList.add("active");
      }

      function hideErrorPopup() {
        const popup = document.getElementById("failed-popup");
        popup.classList.remove("active");
      }

      document
        .getElementById("close-popup-btn")
        .addEventListener("click", () => {
          const successPopup = document.getElementById("success-popup");
          const failedPopup = document.getElementById("failed-popup");

          // Check which popup is active and hide it
          if (successPopup.classList.contains("active")) {
            successPopup.classList.remove("active");
            location.reload();
          }

          if (failedPopup.classList.contains("active")) {
            failedPopup.classList.remove("active");
            location.reload();
          }
        });

      function showLoading() {
        document.querySelector(".loader-overlay").style.display = "flex";
      }

      function hideLoading() {
        document.querySelector(".loader-overlay").style.display = "none";
      }
    </script>
  </body>
</html>
